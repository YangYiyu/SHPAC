<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Register New Device</title>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/themes/metro/easyui.css') }}">
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/themes/mobile.css') }}">
	<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/themes/icon.css') }}">
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/themes/color.css') }}">
	<script type="text/javascript" src="{{ url_for('static', filename='js/jquery.min.js') }}"></script>
	<script type="text/javascript" src="{{ url_for('static', filename='js/jquery.easyui.min.js') }}"></script>
    <script type="text/javascript" src="{{ url_for('static', filename='js/jquery.easyui.mobile.js') }}"></script>
    <script type="text/javascript" src="{{ url_for('static', filename='js/jquery.color.js') }}"></script>
    <script type="text/javascript" src="{{ url_for('static', filename='js/socketio/socket.io.js') }}"></script>
    <style>
        .m-list .m-list-group {
            background-color: #c9c7c7;
        }
    </style>
  </head>
  <body>
    <div id="main" class="easyui-navpanel">
        <header>
            <div class="m-toolbar">
                <div class="m-title">Add New Device</div>
                <div class="m-left">
                    <a href="javascript:void(0)" class="easyui-linkbutton m-back" plain="true" outline="true" onclick="$.mobile.back()">back</a>
                </div>
            </div>
        </header>
        <form id="ff">
            <div class="needhidden" style="margin-bottom:10px;padding:2px 10px;">
                Module: <span id="ff_module" style="font-weight: bold;">{{ configJson.module }}</span>
            </div>
            <div style="margin-bottom:10px;padding:2px 10px;">
                Platform: <span id="ff_platform" style="font-weight: bold;">{{ configJson.platform }}</span>
            </div>
            <div style="margin-bottom:10px;padding:2px 10px;">
                App: <span id="ff_package" style="font-weight: bold;">{{ configJson.package }}</span>
            </div>
            <div class="needhidden" style="margin-bottom:10px;padding:2px 10px;">
                Activity: <span id="ff_activity" style="font-weight: bold;">{{ configJson.activity }}</span>
            </div>
            <div style="margin-bottom:10px;padding:2px 10px;">
                Device: <span id="ff_device" style="font-weight: bold;">{{ configJson.device }}</span>
            </div>
            <div style="margin-bottom:10px;padding:2px 10px;">
                Device ID: <span id="ff_deviceid" style="font-weight: bold;"></span>
            </div>
            <div style="margin-bottom:10px;padding:2px 10px;">
                Vitual Device ID: <span id="ff_virtualid" style="font-weight: bold;">{{ configJson.vitual_deviceid }}</span>
            </div>
            <div style="margin-bottom:10px;padding:2px 10px;">
                Description: <span id="ff_description" style="font-weight: bold;">{{ configJson.description }}</span>
            </div>
            <div class="needhidden" style="margin-bottom:10px;padding:2px 10px;">
                Version: <span id="ff_version" style="font-weight: bold;">{{ configJson.version }}</span>
            </div>
            <div class="needhidden" style="margin-bottom:10px;padding:2px 10px;">
                Script: <span id="ff_script" style="font-weight: bold;">{{ configJson.script }}</span>
            </div>
        </form>
        <ul id="capa_group" class="m-list">
            {% for capa in configJson.capabilityList %}
            <li class="m-list-group">{{ capa.capability }}</li>
            {% for attri in capa.attribute %}
            <div class="needhidden">
                Control: <span id="{{ capa.capability }}-{{ attri.name }}-control" class="attri-control">{{ attri.control }}</span>
            </div>
            <table id="{{ capa.capability }}-{{ attri.name }}-view" class="easyui-datagrid" title="{{ attri.name }}'s clickable xpath list:" style="width:100%;height:200px;" data-options="rownumbers:true,toolbar:'#{{ attri.name }}tb'">
                <thead>
                    <tr>
                        <th data-options="field:'xpath',width:800,align:'left'">xpath</th>
                    </tr>
                </thead>
            </table>
            <div id="{{ attri.name }}tb" style="padding:2px 5px;">
                <div>
                    <a href="#" class="easyui-linkbutton c4" iconCls="icon-record" onclick="doRecord('{{ capa.capability }}-{{ attri.name }}')" style="width:80px;">Record</a>
                </div>
            </div>
            {% endfor %}
            {% endfor %}
        </ul>
        <p style="text-align: center;"><a href="#" class="easyui-linkbutton c1" style="width:90%" onclick="saveRegister()">Save</a></p>
    </div>

    <div id="recordDlg" class="easyui-dialog" title="Record Xpath List" style="width:95%;padding:10px;"
			data-options="closable:true,modal:true,
				buttons: [{
					text:'Save',
					iconCls:'icon-ok',
					handler:function(){
						doSaveRecord(dlg_opener);
					}
				}]
			" closed="true" modal="true">
        <table id="clicklist" class="easyui-datagrid" title="" style="width:100%;height:400px;"
                data-options="singleSelect:false,selectOnCheck:true,checkOnSelect:true,toolbar:'#clicklistft',nowrap:false">
            <thead>
                <tr>
                    <th field="ck" checkbox="true"></th>
                    <th data-options="field:'xpath',width:650">xpath</th>
                </tr>
            </thead>
        </table>
        <div id="clicklistft" style="padding:2px 5px;">
            <a href="#" class="easyui-linkbutton" iconCls="icon-start" onclick="doStartRecord()">Start</a>
            <span style="padding-left: 10px;"></span>
            <a href="#" class="easyui-linkbutton" iconCls="icon-stop" onclick="doStopRecord()">Stop</a>
            <span style="padding-left: 10px;"></span>
            <a href="#" class="easyui-linkbutton" iconCls="icon-remove" onclick="doDeleteRecord()">Remove</a>
            <span style="padding-left: 10px;"></span>
            <a href="#" class="easyui-linkbutton" iconCls="icon-replay" onclick="doReplayRecord()">Replay</a>
        </div>
    </div>

    <div id="waittingDlg" class="easyui-dialog" style="width:95%;padding:10px;" data-options="" title="" closed="true" closable="false" modal="true">
        <div style="text-align:center;">The recording has stopped.</div>
        <div style="text-align:center;"><img src="{{ url_for('static', filename='images/loading.gif') }}"></div>
        <div style="text-align:center;">Now we'll replay your click sequence, please be aware of your phone's screen.</div>
    </div>

    <div id="clickingDlg" class="easyui-dialog" style="width:95%;padding:10px;" data-options="" title="" closed="true" closable="false" modal="true">
        <div style="text-align:center;"><img src="{{ url_for('static', filename='images/loading.gif') }}"></div>
        <div style="text-align:center;">clicking……</div>
    </div>

    <div id="loadingDlg" class="easyui-dialog" style="width:95%;padding:10px;" data-options="" title="" closed="true" closable="false" modal="true">
        <div style="text-align:center;"><img src="{{ url_for('static', filename='images/loading.gif') }}"></div>
        <div style="text-align:center;">waiting……</div>
    </div>

    <script type="text/javascript">
        var dlg_opener;
        function doRecord(opener) {
            dlg_opener = opener;
            $('#recordDlg').dialog('open');
            $.mobile.go("#register");
        }
        function doStartRecord() {
            var package = $("#ff_package").html();
            var activity = $("#ff_activity").html();
            var rl = $('#clicklist').datagrid('getData')["total"];
            if(rl!=0) {
                $.messager.confirm('confirm', 'Do you want to overwrite the existed record?', function (r) {
                    if(r) {
                        $('#clicklist').datagrid('loadData', []);
                        $.post('startRecord',{package:package, activity:activity},function(data,status){
                            if(data=='success') {
                                $.messager.alert('hint', 'The record is beginning, you can trigger the view now.', 'info');
                            }
                        });
                    }
                });
            }
            else {
                $.post('startRecord',{package:package, activity:activity},function(data,status){
                    if(data=='success') {
                        $.messager.alert('hint', 'The record is beginning, you can trigger the view now.', 'info');
                    }
                });
            }
        }
        function doStopRecord() {
            $.post('stopRecord',{},function(data,status){
                if(data=='success') {
                    $('#waittingDlg').dialog('open');
                    $.post('replayRecord',{},function(data,status){
                        if(data && data!='failed') {
                            $('#waittingDlg').dialog('close');
                            $.messager.confirm('confirm', 'Are the click sequence consistent with your previous operations?', function (r) {
                                if (r) {
                                    $('#clicklist').datagrid('loadData', data);
                                }
                                else {
                                    $.messager.alert('hint', 'You may try this record again.', 'info');
                                }
                            });
                        }
                    });
                }
            });
        }
        function doDeleteRecord() {
            var rows = $('#clicklist').datagrid('getSelections');
            if(rows.length == 0) {
                $.messager.alert('hint','Please select one record at least!','info');
            }
            if (rows.length>0) {
                rows.forEach(function(r){
                    $('#clicklist').datagrid('deleteRow', $('#clicklist').datagrid('getRowIndex', r)); 
                });
            }
        }
        function doReplayRecord() {
            var rows = $('#clicklist').datagrid('getSelections');
            if(rows.length>0) {
                $('#clickingDlg').dialog('open');
                var app = $("#ff_package").html();
                var activity = $("#ff_activity").html();
                $.post('replayXpath', {xpaths:JSON.stringify(rows), app:app, activity:activity}, function(data,status){
                    $('#clickingDlg').dialog('close');
                    if(data && data=='success') {
                        $.messager.alert('hint','Replaying completed!','info');
                    }
                });
            }
        }
        function doSaveRecord(target) {
            if(target) {
                var records = $('#clicklist').datagrid('getData')["rows"];
                $(`#${target}-view`).datagrid("loadData", records);
                $('#recordDlg').dialog('close');
                $('#clicklist').datagrid('loadData', []);
            }
        }
    </script>
    <script type="text/javascript">
        $(".needhidden").hide();
        var socket = null;
        $(document).ready(function(){
            socket = io.connect("http://" + document.domain + ":" + location.port + "?username=owner");
            socket.on("config_status", function(msg) {
                $("#ff_deviceid").html(msg.deviceid);
            });
        });
        function saveRegister() {
            var module_ = $("#ff_module").html();
            var platform_ = $("#ff_platform").html();
            var package_ = $("#ff_package").html();
            var activity_ = $("#ff_activity").html();
            var device_ = $("#ff_device").html();
            var deviceid_ = $("#ff_deviceid").html();
            var virtualid_ = $("#ff_virtualid").html();
            var description_ = $("#ff_description").html();
            var version_ = $("#ff_version").html();
            var script_ = $("#ff_script").html();

            if(!deviceid_ || !virtualid_) {
                $.messager.alert('hint', 'device id cannot be empty!', 'info');
                return; 
            }

            var viewIdStr = $('.easyui-datagrid').map(function(){return this.id}).get().join();
            var viewIdArray = viewIdStr.split(",");
            var xpath_amp = {};
            for(var i in viewIdArray){
                var viewId = viewIdArray[i];
                if(viewId=="clicklist") {
                    continue;
                }
                var xpathData = $(`#${viewId}`).datagrid("getData").rows;
                xpath_amp[viewId] = xpathData;
            }

            var controlIdStr = $('.attri-control').map(function(){return this.id}).get().join();
            var controlIdArray = controlIdStr.split(",");
            var control_amp = {};
            for(var i in controlIdArray){
                var controlId = controlIdArray[i];
                var controlText = $(`#${controlId}`).html();
                control_amp[controlId] = controlText;
            }

            $("#loadingDlg").dialog("open");
            $.post("saveRegisterInfo", {
                module: module_,
                platform: platform_,
                package: package_,
                activity: activity_,
                device: device_,
                deviceid: deviceid_,
                virtualid: virtualid_,
                description: description_,
                version: version_,
                script: script_,
                control_data: JSON.stringify(control_amp),
                xpath_data: JSON.stringify(xpath_amp)
            }, function(data, status){
                if(data=="success") {
                    $.messager.alert('hint','Register device success!','info');
                    location.href="AdminControlPage";
                }
            });
        }
    </script>
  </body>
</html>