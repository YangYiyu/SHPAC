<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>PolicyManagement</title>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/themes/metro/easyui.css') }}">
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/themes/mobile.css') }}">
	<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/themes/icon.css') }}">
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/themes/color.css') }}">
	<script type="text/javascript" src="{{ url_for('static', filename='js/jquery.min.js') }}"></script>
	<script type="text/javascript" src="{{ url_for('static', filename='js/jquery.easyui.min.js') }}"></script>
    <script type="text/javascript" src="{{ url_for('static', filename='js/jquery.easyui.mobile.js') }}"></script>
    <script type="text/javascript" src="{{ url_for('static', filename='js/jquery.color.js') }}"></script>
    <style>
        .m-list .m-list-group {
            background-color: #c9c7c7;
        }
    </style>
    
  </head>
  <body>
    <div id="main" class="easyui-navpanel">
        <header>
            <div class="m-toolbar">
                <div class="m-title">Policy Management</div>
                <div class="m-left">
                    <a href="javascript:void(0)" class="easyui-linkbutton m-back" plain="true" outline="true" onclick="$.mobile.back()">back</a>
                </div>
            </div>
        </header>
        <div class="easyui-accordion" fit="true" border="false">
            <div class="easyui-navpanel">
                <table id="policy" class="easyui-datagrid" title="" style="width:100%;height:100%;" data-options="rownumbers:true,singleSelect:true,url:'getAllPolicyDatagrid',method:'post',toolbar:'#tb',pagination:true">
                    <thead>
                        <tr>
                            <th data-options="field:'id',width:120,hidden:true">id</th>
                            <th data-options="field:'state',width:60,align:'center',formatter:stateformater">state</th>
                            <th data-options="field:'name',width:60,align:'center'">name</th>
                            <th data-options="field:'user',width:80,align:'center'">user</th>
                            <th data-options="field:'device',width:180,align:'center'">device</th>
                            <th data-options="field:'capability',width:160,align:'center'">capability</th>
                        </tr>
                    </thead>
                </table>
                <div id="tb" style="padding:2px 5px;">  
                    <div style="font-size:14px;padding-top: 10px;">
                        <input class="easyui-textbox" id="userS" style="line-height:18px;border:1px solid #ccc" prompt="username">
                        <input class="easyui-combobox" id="platformS" style="line-height:18px;border:1px solid #ccc" prompt="platform">
                        <input class="easyui-combobox" id="deviceS" style="line-height:18px;border:1px solid #ccc" prompt="device">
                        <input class="easyui-combobox" id="capabilityS" style="line-height:18px;border:1px solid #ccc" prompt="capability">
                        <a href="#" class="easyui-linkbutton c4" style="margin-top: 10px;" iconCls="icon-search" onclick="doSearch()">Search</a>
                        <a href="#" class="easyui-linkbutton c6" style="margin-top: 10px;" iconCls="icon-tip" onclick="doShow()">Show</a>
                        <a href="#" class="easyui-linkbutton c2" style="margin-top: 10px;" iconCls="icon-edit" onclick="doCheck()">Check</a>
                        <a href="#" class="easyui-linkbutton c3" style="margin-top: 10px;" iconCls="icon-cancel" onclick="doDelete()">Remove</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="showPolicyDlg" class="easyui-dialog" title="Show Policy" style="width:100%;padding:10px;" data-options="
            conCls: 'icon-new',
            buttons: [
                {
                    text:'close',
                    iconCls:'icon-cancel',
                    handler:function(){
                        $('#showPolicyDlg').dialog('close');
                    }
                }
            ]
        " closed="true" modal="true">
        <form id="showPolicyForm" class="easyui-form" method="post" data-options="novalidate:true">
			<table style="width:100%;" border="1" cellspacing="0">
	    		<tr>
	    		    <td>
                        id:&nbsp;&nbsp;
                    </td>
                    <td>
                        <span id="policy_id"></span>
                    </td>
                </tr>
                <tr>
	    		    <td>
                        name:&nbsp;&nbsp;
                    </td>
                    <td>
                        <span id="policy_name"></span>
                    </td>
                </tr>
                <tr>
	    		    <td>
                        user:&nbsp;&nbsp;
                    </td>
                    <td>
                        <span id="policy_user"></span>
                    </td>
                </tr>
                <tr>
	    		    <td>
                        device:&nbsp;&nbsp;
                    </td>
                    <td>
                        <span id="policy_device"></span>
                    </td>
                </tr>
                <tr>
	    		    <td>
                        capability:&nbsp;&nbsp;
                    </td>
                    <td>
                        <span id="policy_capability"></span>
                    </td>
                </tr>
                <tr>
	    		    <td>
                        status_permit:&nbsp;&nbsp;
                    </td>
                    <td>
                        <span id="policy_status_permit"></span>
                    </td>
                </tr>
                <tr>
	    		    <td>
                        action_permit:&nbsp;&nbsp;
                    </td>
                    <td>
                        <span id="policy_action_permit"></span>
                    </td>
                </tr>
                <tr>
	    		    <td>
                        attri_permit:&nbsp;&nbsp;
                    </td>
                    <td>
                        <span id="policy_attri_permit"></span>
                    </td>
                </tr>
                <tr>
	    		    <td>
                        time_condition:&nbsp;&nbsp;
                    </td>
                    <td>
                        <span id="policy_time_condition"></span>
                    </td>
                </tr>
                <tr>
	    		    <td>
                        location_condition:&nbsp;&nbsp;
                    </td>
                    <td>
                        <span id="policy_location_condition"></span>
                    </td>
                </tr>
                <tr>
	    		    <td>
                        attri_condition:&nbsp;&nbsp;
                    </td>
                    <td>
                        <span id="policy_attri_condition"></span>
                    </td>
                </tr>
                <tr>
	    		    <td>
                        submitter:&nbsp;&nbsp;
                    </td>
                    <td>
                        <span id="policy_submitter"></span>
                    </td>
                </tr>
                <tr>
	    		    <td>
                        level:&nbsp;&nbsp;
                    </td>
                    <td>
                        <span id="policy_level"></span>
                    </td>
                </tr>
                <tr>
	    		    <td>
                        state:&nbsp;&nbsp;
                    </td>
                    <td>
                        <span id="policy_state"></span>
                    </td>
                </tr>
	    	</table>
        </form>
    </div>

    <div id="checkPolicyDlg" class="easyui-dialog" title="Check New Policy" style="width:100%;height:600px;padding:10px;" data-options="
            conCls: 'icon-new',
            buttons: [
                {
                    text:'close',
                    iconCls:'icon-cancel',
                    handler:function(){
                        $('#checkPolicyDlg').dialog('close');
                    }
                }
            ]
        " closed="true" modal="true">
        <form id="checkPolicyForm" class="easyui-form" method="post" data-options="novalidate:true">
			<table cellpadding="5" >
	    		<tr>
	    		    <td>
                        <table>
                            <tr>
                                <td style="text-align: center;"><img id="policy_relation_img" width=36></td>
                                <td id="policy_relation"></td>
                            </tr>
                        </table>
                    </td>
                </tr>
                <tr>
	    		    <td>
                        Suggestion: <span id="handle" style="font-weight: bold;font-size: 15px;"></span>
                    </td>
                </tr>
                <tr id="suggestion">
	    		    <td>
                        <div id="modified_policy" style="text-align: center;"></div>
                    </td>
                </tr>
                <tr>
	    		    <td id="actionBtn" style="text-align: center;"></td>
                </tr>
	    	</table>
        </form>
    </div>
        
    <div id="loadingDlg" class="easyui-dialog" style="width:95%;padding:10px;" data-options="" title="" closed="true" closable="false" modal="true">
        <div style="text-align:center;"><img src="{{ url_for('static', filename='images/loading.gif') }}"></div>
        <div style="text-align:center;">waitting……</div>
    </div>

    <script type="text/javascript">
        function stateformater(value,row,index) {
            if(value=="check") {
                return "<img src=\"{{ url_for('static', filename='images/check.png') }}\" height=24px style='padding-top:5px;'>";
            }
            if(value=="reject") {
                return "<img src=\"{{ url_for('static', filename='images/reject.png') }}\" height=24px style='padding-top:5px;'>";
            }
            if(value=="accept") {
                return "<img src=\"{{ url_for('static', filename='images/accept.png') }}\" height=24px style='padding-top:5px;'>";
            }
        }

        function doSearch() {
            $('#policy').datagrid({
                url: 'getAllPolicyDatagrid',
                method: 'POST',
                queryParams: {
                    user: $('#userS').textbox('getValue'),
                    device: $('#deviceS').textbox('getValue'),
                    capability: $('#capabilityS').textbox('getValue')
                }
            });
        }
        function doShow() {
            var row = $('#policy').datagrid('getSelected');
            if(row == null) {
                $.messager.alert('hint','Plesae select one policy','info');
            }
            $.post('getPolicy', {id: row.id}, function(data, status){
                if(data) {
                    $("#showPolicyDlg").dialog("open");
                    $("#policy_id").html(data.id);
                    $("#policy_name").html(data.name);
                    $("#policy_user").html(data.user);
                    $("#policy_device").html(data.device);
                    $("#policy_capability").html(data.capability);
                    $("#policy_status_permit").html(data.status_permit.toString());
                    $("#policy_action_permit").html(data.action_permit.toString());
                    $("#policy_attri_permit").html(JSON.stringify(data.attri_permit));
                    $("#policy_time_condition").html(JSON.stringify(data.time_condition));
                    $("#policy_location_condition").html(data.location_condition);
                    $("#policy_attri_condition").html(JSON.stringify(data.attri_condition));
                    $("#policy_submitter").html(data.submitter);
                    $("#policy_level").html(data.level);
                    $("#policy_state").html(data.state);
                }
            });
        }
        function doShowById(id) {
            if(id) {
                $.post('getPolicy', {id: id}, function(data, status){
                    if(data) {
                        $("#showPolicyDlg").dialog("open");
                        $("#policy_id").html(data.id);
                        $("#policy_name").html(data.name);
                        $("#policy_user").html(data.user);
                        $("#policy_device").html(data.device);
                        $("#policy_capability").html(data.capability);
                        $("#policy_status_permit").html(data.status_permit.toString());
                        $("#policy_action_permit").html(data.action_permit.toString());
                        $("#policy_attri_permit").html(JSON.stringify(data.attri_permit));
                        $("#policy_time_condition").html(JSON.stringify(data.time_condition));
                        $("#policy_location_condition").html(data.location_condition);
                        $("#policy_attri_condition").html(JSON.stringify(data.attri_condition));
                        $("#policy_submitter").html(data.submitter);
                        $("#policy_level").html(data.level);
                        $("#policy_state").html(data.state);
                    }
                });
            }
        }
        function doCheck() {
            var row = $('#policy').datagrid('getSelected');
            if(row == null) {
                $.messager.alert('hint','Plesae select one policy','info');
            }
            $.post('checkPolicyById', {policyid:row.id}, function(data, status){
                if(data) {
                    $("#checkPolicyDlg").dialog("open");

                    if(data.policy_relation=="PolicyRelation.unrelated") {
                        $("#policy_relation_img").attr("src", "{{ url_for('static', filename='images/accept.png') }}" );
                        $("#policy_relation").html("<a href='#' onclick='doShowById(\""+row.id+"\")'>This policy</a> could be accepted!");
                    }
                    else if(data.policy_relation=="PolicyRelation.duplicated") {
                        $("#policy_relation_img").attr("src", "{{ url_for('static', filename='images/error.png') }}" );
                        $("#policy_relation").html("<a href='#' onclick='doShowById(\""+row.id+"\")'>This policy</a> is <span style='color:red;'>duplicated</span> with <a href='#' onclick='doShowById(\""+data.related_policy.id+"\")'>related one</a>!");
                    }
                    else if(data.policy_relation=="PolicyRelation.overlaped_condition") {
                        $("#policy_relation_img").attr("src", "{{ url_for('static', filename='images/warning.png') }}" );
                        $("#policy_relation").html("<a href='#' onclick='doShowById(\""+row.id+"\")'>This policy</a>'s <span style='color:red;'>condition is overlaped</span> with <a href='#' onclick='doShowById(\""+data.related_policy.id+"\")'>related one</a>!");
                    }
                    else if(data.policy_relation=="PolicyRelation.overlaped_permit") {
                        $("#policy_relation_img").attr("src", "{{ url_for('static', filename='images/warning.png') }}" );
                        $("#policy_relation").html("<a href='#' onclick='doShowById(\""+row.id+"\")'>This policy</a>'s <span style='color:red;'>permission is interfered</span> with <a href='#' onclick='doShowById(\""+data.related_policy.id+"\")'>related one</a>!");
                    }
                    else if(data.policy_relation=="PolicyRelation.overlaped_condition_permit") {
                        $("#policy_relation_img").attr("src", "{{ url_for('static', filename='images/warning.png') }}" );
                        $("#policy_relation").html("<a href='#' onclick='doShowById(\""+row.id+"\")'>This policy</a>'s <span style='color:red;'>condition and permission are both overlaped</span> with <a href='#' onclick='doShowById(\""+data.related_policy.id+"\")'>related one</a>!");
                    }
                    else if(data.policy_relation=="PolicyRelation.preinclude_condition") {
                        $("#policy_relation_img").attr("src", "{{ url_for('static', filename='images/warning.png') }}" );
                        $("#policy_relation").html("<a href='#' onclick='doShowById(\""+row.id+"\")'>This policy</a>'s <span style='color:red;'>condition has contained</span> the <a href='#' onclick='doShowById(\""+data.related_policy.id+"\")'>related one</a>!");
                    }
                    else if(data.policy_relation=="PolicyRelation.preinclude_permit") {
                        $("#policy_relation_img").attr("src", "{{ url_for('static', filename='images/warning.png') }}" );
                        $("#policy_relation").html("<a href='#' onclick='doShowById(\""+row.id+"\")'>This policy</a>'s <span style='color:red;'>permission has contained</span> the <a href='#' onclick='doShowById(\""+data.related_policy.id+"\")'>related one</a>!");
                    }
                    else if(data.policy_relation=="PolicyRelation.preinclude_condition_permit") {
                        $("#policy_relation_img").attr("src", "{{ url_for('static', filename='images/warning.png') }}" );
                        $("#policy_relation").html("<a href='#' onclick='doShowById(\""+row.id+"\")'>This policy</a>'s <span style='color:red;'>condition and permission has contained</span> the <a href='#' onclick='doShowById(\""+data.related_policy.id+"\")'>related one</a>!");
                    }
                    else if(data.policy_relation=="PolicyRelation.postinclude_condition") {
                        $("#policy_relation_img").attr("src", "{{ url_for('static', filename='images/warning.png') }}" );
                        $("#policy_relation").html("<a href='#' onclick='doShowById(\""+row.id+"\")'>This policy</a>'s <span style='color:red;'>condition has been covered</span> by the <a href='#' onclick='doShowById(\""+data.related_policy.id+"\")'>related one</a>!");
                    }
                    else if(data.policy_relation=="PolicyRelation.postinclude_permit") {
                        $("#policy_relation_img").attr("src", "{{ url_for('static', filename='images/warning.png') }}" );
                        $("#policy_relation").html("<a href='#' onclick='doShowById(\""+row.id+"\")'>This policy</a>'s <span style='color:red;'>permission has been covered</span> by the <a href='#' onclick='doShowById(\""+data.related_policy.id+"\")'>related one</a>!");
                    }
                    else if(data.policy_relation=="PolicyRelation.postinclude_condition_permit") {
                        $("#policy_relation_img").attr("src", "{{ url_for('static', filename='images/warning.png') }}" );
                        $("#policy_relation").html("<a href='#' onclick='doShowById(\""+row.id+"\")'>This policy</a>'s <span style='color:red;'>condition and permission has been covered</span> by the <a href='#' onclick='doShowById(\""+data.related_policy.id+"\")'>related one</a>!");
                    }
                    else if(data.policy_relation=="PolicyRelation.hard_conflict") {
                        $("#policy_relation_img").attr("src", "{{ url_for('static', filename='images/error.png') }}" );
                        $("#policy_relation").html("<a href='#' onclick='doShowById(\""+row.id+"\")'>This policy</a> is <span style='color:red;'>completely conflicted</span> with <a href='#' onclick='doShowById(\""+data.related_policy.id+"\")'>related one</a>!");
                    }
                    else if(data.policy_relation=="PolicyRelation.soft_conflict") {
                        $("#policy_relation_img").attr("src", "{{ url_for('static', filename='images/warning.png') }}" );
                        $("#policy_relation").html("<a href='#' onclick='doShowById(\""+row.id+"\")'>This policy</a> is <span style='color:red;'>partially conflicted</span> with <a href='#' onclick='doShowById(\""+data.related_policy.id+"\")'>related one</a>!");
                    }
                    else if(data.policy_relation=="PolicyRelation.independent") {
                        $("#policy_relation_img").attr("src", "{{ url_for('static', filename='images/accept.png') }}" );
                        $("#policy_relation").html("<a href='#' onclick='doShowById(\""+row.id+"\")'>This policy</a> could be accepted!");
                    }

                    $("#suggestion").hide();
                    var handleStr = "";
                    if(data.handle.length==1 && data.handle[0]=="accept_np") {
                        handleStr = "You may accept this policy";
                        $("#checkPolicyDlg").css("height","");
                        var btn_html = '';
                        btn_html += '<a href="#" class="easyui-linkbutton c4" iconCls="icon-ok" onclick="doAcceptSuggestion(\''+row.id+'\',\''+data.related_policy.id+'\',\'accept_np\')">accept suggestion</a>';
                        btn_html += '&nbsp;&nbsp;';
                        btn_html += '<a href="#" class="easyui-linkbutton c3" iconCls="icon-no" onclick="doRejectPolicy()">reject policy</a>';
                        $("#actionBtn").html(btn_html);
                        $.parser.parse($("#actionBtn"));
                    }
                    if(data.handle.length==1 && data.handle[0]=="accept_np_reject_op") {
                        handleStr = "You may accept this policy, and reject the related policy.";
                        $("#checkPolicyDlg").css("height","");
                        var btn_html = '';
                        btn_html += '<a href="#" class="easyui-linkbutton c4" iconCls="icon-ok" onclick="doAcceptSuggestion(\''+row.id+'\',\''+data.related_policy.id+'\',\'accept_np\')">accept suggestion</a>';
                        btn_html += '&nbsp;&nbsp;';
                        btn_html += '<a href="#" class="easyui-linkbutton c3" iconCls="icon-no" onclick="doRejectPolicy()">reject policy</a>';
                        $("#actionBtn").html(btn_html);
                        $.parser.parse($("#actionBtn"));
                    }
                    if(data.handle.length==1 && data.handle[0]=="reject_np") {
                        handleStr = "You may reject this policy.";
                        $("#checkPolicyDlg").css("height","");
                        var btn_html = '';
                        btn_html += '<a href="#" class="easyui-linkbutton c3" iconCls="icon-no" onclick="doRejectPolicy()">reject policy</a>';
                        $("#actionBtn").html(btn_html);
                        $.parser.parse($("#actionBtn"));
                    }
                    if(data.handle.length>=1 && (data.handle[0].indexOf("accept_mnp")!=-1 || data.handle[0].indexOf("accept_mop")!=-1)) {
                        handleStr += "You may agree with one of the following modified policies:";
                        if(data.suggested_policy) {
                            $("#btnAccept").hide();
                            $("#modified_policy").html(getSuggestPolicyTable(data.suggested_policy, data.handle, row.id, data.related_policy.id));
                            $("#suggestion").show();
                            $.parser.parse($("#suggestion"));
                        }
                    }
                    $("#handle").html(handleStr);
                }
            });
        }
        function getSuggestPolicyTable(suggested_policy, handle, n_p_id, o_p_id) {
            var pl_html = "";
            for(var i=0;i<suggested_policy.length;i++) {
                var item = suggested_policy[i];
                pl_html += 'Alternative ' + (i+1) + ':';
                pl_html += '<table style="width:100%;" border="1" cellspacing="0">';
                pl_html += '    <tr>';
                pl_html += '        <td>name:</td>';
                pl_html += '        <td>'+item.name+'</td>';
                pl_html += '    </tr>';
                pl_html += '    <tr>';
                pl_html += '        <td>user name:</td>';
                pl_html += '        <td>'+item.user+'</td>';
                pl_html += '    </tr>';
                pl_html += '    <tr>';
                pl_html += '        <td>device id:</td>';
                pl_html += '        <td>'+item.device+'</td>';
                pl_html += '    </tr>';
                pl_html += '    <tr>';
                pl_html += '        <td>capability:</td>';
                pl_html += '        <td>'+item.capability+'</td>';
                pl_html += '    </tr>';
                pl_html += '    <tr>';
                pl_html += '        <td>status_permit:</td>';
                pl_html += '        <td>'+item.status_permit+'</td>';
                pl_html += '    </tr>';
                pl_html += '    <tr>';
                pl_html += '        <td>action_permit:</td>';
                pl_html += '        <td>'+item.action_permit+'</td>';
                pl_html += '    </tr>';
                pl_html += '    <tr>';
                pl_html += '        <td>attri_permit:</td>';
                pl_html += '        <td>'+JSON.stringify(item.attri_permit)+'</td>';
                pl_html += '    </tr>';
                pl_html += '    <tr>';
                pl_html += '        <td>time_condition:</td>';
                pl_html += '        <td>'+JSON.stringify(item.time_condition)+'</td>';
                pl_html += '    </tr>';
                pl_html += '    <tr>';
                pl_html += '        <td>location_condition:</td>';
                pl_html += '        <td>'+item.location_condition+'</td>';
                pl_html += '    </tr>';
                pl_html += '    <tr>';
                pl_html += '        <td>attri_condition:</td>';
                pl_html += '        <td>'+JSON.stringify(item.attri_condition)+'</td>';
                pl_html += '    </tr>';
                pl_html += '</table>';
                var s_p_json_str = JSON.stringify(item).replaceAll('"', '\\\"');
                if(handle[i]=="accept_mnp") {
                    pl_html += '<a href="#" class="easyui-linkbutton c1" style="width:100%;height:25px;" onclick=\'doAgreeSuggestPolicy("'+s_p_json_str+'","'+n_p_id+'","'+o_p_id+'","'+handle[i]+'")\'>accept this</a>';
                }
                else if(handle[i]=="accept_mnp_reject_op") {
                    pl_html += '<a href="#" class="easyui-linkbutton c1" style="width:100%;height:25px;" onclick=\'doAgreeSuggestPolicy("'+s_p_json_str+'","'+n_p_id+'","'+o_p_id+'","'+handle[i]+'")\'>accept this, reject overlapped one</a>';
                }
                else if(handle[i]=="accept_np_accept_mop") {
                    pl_html += '<a href="#" class="easyui-linkbutton c1" style="width:100%;height:25px;" onclick=\'doAgreeSuggestPolicy("'+s_p_json_str+'","'+n_p_id+'","'+o_p_id+'","'+handle[i]+'")\'>modify the overlapped to this</a>';
                }
                pl_html += "<br><br>";
            }
            return pl_html;
        }
        function doAcceptSuggestion(n_p_id, o_p_id, handle) {
            var row = $('#policy').datagrid('getSelected');
            if(row == null) {
                $.messager.alert('hint','Plesae select one policy','info');
            }
            $.post('acceptSuggestion', {o_p_id:o_p_id,n_p_id:n_p_id,handle:handle}, function(data, status){
                if(data=="success") {
                    $("#checkPolicyDlg").dialog("close");
                    $('#policy').datagrid('clearSelections');
                    $('#policy').datagrid('reload');
                }
                else{
                    $.messager.alert('hint',data,'info');
                }
            });
        }
        function doAgreeSuggestPolicy(modified_policy, n_p_id, o_p_id, handle) {
            if(modified_policy) {
                $.post('agreeSuggestPolicy', {modified_policy:modified_policy,n_p_id:n_p_id,o_p_id:o_p_id,handle:handle}, function(data, status){
                    if(data=="success") {
                        $("#checkPolicyDlg").dialog("close");
                        $('#policy').datagrid('clearSelections'); 
                        $('#policy').datagrid('reload');
                    }
                    else {
                        $.messager.alert('hint',data,'info');
                    }
                });
            }
        }
        function doRejectPolicy() {
            var row = $('#policy').datagrid('getSelected');
            if(row == null) {
                $.messager.alert('hint','Plesae select one policy','info');
            }
            $.post('rejectPolicy', {id:row.id}, function(data, status){
                if(data=="success") {
                    $("#checkPolicyDlg").dialog("close");
                    $('#policy').datagrid('clearSelections'); 
                    $('#policy').datagrid('reload');
                }
                else{
                    $.messager.alert('hint',data,'info');
                }
            });
        }
	    function doDelete() {
            var row = $('#policy').datagrid('getSelected');
            if(row == null) {
                $.messager.alert('hint','Plesae select one policy','info');
            }
            if (row) {
                $.messager.confirm('confirm', 'Are you sure about deleting policy?', function (r) {
                    if (r) {
                        $('#loadingDlg').dialog('open');
                        $.post('removePolicy', { id: row.id }, function (result) {
                            $('#loadingDlg').dialog('close');
                            if (result=='success') {
                                $('#policy').datagrid('clearSelections'); //清空选中的行  
                                // $.messager.alert('hint', 'success', 'info'); 
                                $('#policy').datagrid('reload');    // reload the data 
                            } else {
                                $.messager.show({   // show error message 
                                    title: 'Error',
                                    msg: result
                                });
                            }
                        });
                    }
                });
            }
        }

        $(document).ready(function(){
            $("#platformAdd").combobox({
                editable: false,
                panelHeight: 'auto',
				valueField: 'id',
    			textField: 'name',
    			url: 'getAllPlatformJson',
                onClick: function(item){
                    $("#deviceAdd").combobox({
                        editable: false,
                        panelHeight: 'auto',
                        valueField: 'id',
                        textField: 'name',
                        url: 'getAllDeviceJson?platform='+item.id,
                        onClick: function(item){
                            $("#capabilityAdd").combobox({
                                editable: false,
                                panelHeight: 'auto',
                                valueField: 'id',
                                textField: 'name',
                                url: 'getAllCapabilityJson?device='+item.id
                            })
                        }
                    })
                }
            });
        });
    </script>
  </body>
</html>